<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Leave Calendar</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Etak Logistics" class="logo">
        </div>
        <ul class="navbar-menu">
            <li><a href="{{ url_for('index') }}">Home</a></li>
            <li><a href="{{ url_for('timetable.timetable_form') }}">Monthly Timetable</a></li>
            <li><a href="{{ url_for('hr_calendar.display_calendar') }}" class="active">HR Calendar</a></li>
            <li><a href="{{ url_for('logout') }}">Logout</a></li>
        </ul>
    </nav>
    <div class="container">
        <h1>HR Leave Calendar - {{ month_name }}</h1>

        <!-- View Toggle -->
        <div class="view-toggle">
            <button id="traditionalViewBtn" class="{% if current_view == 'traditional' %}active{% endif %}">Traditional View</button>
            <button id="gridViewBtn" class="{% if current_view == 'grid' %}active{% endif %}">Employee Grid View</button>
        </div>

        <!-- Traditional Calendar View -->
        <div id="traditionalView" class="calendar-container {% if current_view == 'traditional' %}active{% endif %}">
            <form method="POST" action="{{ url_for('hr_calendar.display_calendar') }}" class="form-container">
                <div class="form-row">
                    <div class="form-group">
                        <label for="month_year">Select Month and Year:</label>
                        <input type="month" id="month_year" name="month_year" value="{{ year }}-{{ '%02d' % month }}" required>
                    </div>
                    <div class="form-group checkboxes">
                        <label>Departments:</label>
                        <label><input type="checkbox" name="chkTrans" {% if 'TRANS' in departments %}checked{% endif %}> Transportation</label>
                        <label><input type="checkbox" name="chkWareh" {% if 'WAREH' in departments %}checked{% endif %}> Warehouse</label>
                        <label><input type="checkbox" name="chkOffice" {% if 'OFFICE' in departments %}checked{% endif %}> Office</label>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" name="chkShow" {% if show_official_only %}checked{% endif %}> Show Official Leaves Only</label>
                    </div>
                    <div class="form-buttons">
                        <button type="submit">Update Calendar</button>
                    </div>
                </div>
                <input type="hidden" name="current_view" value="traditional">
            </form>

            <table class="calendar">
                <thead>
                    <tr>
                        <th class="sunday">Sun</th>
                        <th>Mon</th>
                        <th>Tue</th>
                        <th>Wed</th>
                        <th>Thu</th>
                        <th>Fri</th>
                        <th>Sat</th>
                    </tr>
                </thead>
                <tbody>
                    {% for week in calendar %}
                    <tr>
                        {% for day in week %}
                        <td {% if day != 0 and day in holiday_days %}class="holiday"{% elif day != 0 and loop.index0 == 0 %}class="sunday"{% endif %}>
                            {% if day != 0 %}
                                <div class="day">{{ day }}</div>
                                {% if day in holiday_names %}
                                    <span class="holiday-name">{{ holiday_names[day] }}</span>
                                {% endif %}
                                {% if day in leave_data %}
                                    <div class="leave-details">
                                        {% for key, leave in leave_data[day].items() %}
                                            <div class="leave-entry {% if leave.status == 'On Hold' %}temp{% else %}approved{% endif %} {% if leave.leave_type == 7 %}official{% endif %}">
                                                <span class="leave-type">{{ leave.short_description }}</span> <!-- Removed ({{ leave.status }}) -->
                                                <div class="staff-names">
                                                    {% for staff in leave.staff %}
                                                        <a href="{{ url_for('hr_calendar.staff_leaves', staff_code=staff.staff_code, year=year, month=month) }}" class="staff-name">
                                                            {{ staff.staff_name }}
                                                        </a>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <form method="POST" action="{{ url_for('hr_calendar.generate_calendar_pdf') }}" class="form-container">
                <div class="form-row">
                    <div class="form-group">
                        <label for="filename">PDF Filename:</label>
                        <input type="text" name="filename" value="hr_leave_calendar_{{ year }}_{{ '%02d' % month }}.pdf">
                    </div>
                    <div class="form-buttons">
                        <button type="submit">Generate PDF</button>
                    </div>
                </div>
                <input type="hidden" name="year" value="{{ year }}">
                <input type="hidden" name="month" value="{{ month }}">
                {% for dept in departments %}
                    <input type="hidden" name="departments" value="{{ dept }}">
                {% endfor %}
                <input type="hidden" name="show_official_only" value="{{ 'on' if show_official_only else 'off' }}">
            </form>
        </div>

        <!-- Employee Grid View -->
        <div id="gridView" class="grid-container {% if current_view == 'grid' %}active{% endif %}">
            <form method="POST" action="{{ url_for('hr_calendar.display_calendar') }}" class="form-container">
                <div class="form-row">
                    <div class="form-group">
                        <label for="month_year">Select Month and Year:</label>
                        <input type="month" id="month_year" name="month_year" value="{{ year }}-{{ '%02d' % month }}" required>
                    </div>
                    <div class="form-group checkboxes">
                        <label>Departments:</label>
                        <label><input type="checkbox" name="chkTrans" {% if 'TRANS' in departments %}checked{% endif %}> Transportation</label>
                        <label><input type="checkbox" name="chkWareh" {% if 'WAREH' in departments %}checked{% endif %}> Warehouse</label>
                        <label><input type="checkbox" name="chkOffice" {% if 'OFFICE' in departments %}checked{% endif %}> Office</label>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" name="chkShow" {% if show_official_only %}checked{% endif %}> Show Official Leaves Only</label>
                    </div>
                    <div class="form-buttons">
                        <button type="submit">Update Calendar</button>
                    </div>
                </div>
                <input type="hidden" name="current_view" value="grid">
            </form>

            <table class="grid-table">
                <thead>
                    <tr>
                        <th class="employee sortable">
                            <a href="{{ url_for('hr_calendar.display_calendar', year=year, month=month, sort='StaffCode' if sort_field != 'StaffCode' else 'EName', departments=departments, show_official_only='on' if show_official_only else 'off') }}">
                                Employee
                                {% if sort_field == 'StaffCode' %}
                                    <span class="sort-indicator">{{ '↑' if sort_direction == 'ASC' else '↓' }}</span>
                                {% elif sort_field == 'EName' %}
                                    <span class="sort-indicator">{{ '↑' if sort_direction == 'ASC' else '↓' }}</span>
                                {% endif %}
                            </a>
                        </th>
                        {% for day in range(1, days_in_month + 1) %}
                            <th {% if day in holiday_days %}class="holiday"{% elif days_of_week[day] == 0 %}class="sunday"{% endif %}>{{ day }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for staff in staff_leave_data %}
                    <tr>
                        <td class="employee">{{ staff.staff_name }}</td>
                        {% for day in range(1, days_in_month + 1) %}
                            <td {% if day in holiday_days %}class="holiday"{% elif days_of_week[day] == 0 %}class="sunday"{% endif %}>
                                {% if staff.leaves[day] %}
                                    <div class="leave-entry {% if staff.leaves[day].status == 'On Hold' %}temp{% else %}approved{% endif %} {% if staff.leaves[day].leave_type == 7 %}official{% endif %}">
                                        {{ staff.leaves[day].short_description }}
                                    </div>
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const traditionalViewBtn = document.getElementById('traditionalViewBtn');
        const gridViewBtn = document.getElementById('gridViewBtn');
        const traditionalView = document.getElementById('traditionalView');
        const gridView = document.getElementById('gridView');

        traditionalViewBtn.addEventListener('click', () => {
            traditionalViewBtn.classList.add('active');
            gridViewBtn.classList.remove('active');
            traditionalView.classList.add('active');
            gridView.classList.remove('active');
            // Update the hidden input in both forms to reflect the current view
            document.querySelectorAll('input[name="current_view"]').forEach(input => {
                input.value = 'traditional';
            });
        });

        gridViewBtn.addEventListener('click', () => {
            gridViewBtn.classList.add('active');
            traditionalViewBtn.classList.remove('active');
            gridView.classList.add('active');
            traditionalView.classList.remove('active');
            // Update the hidden input in both forms to reflect the current view
            document.querySelectorAll('input[name="current_view"]').forEach(input => {
                input.value = 'grid';
            });
        });
    </script>
</body>
</html>