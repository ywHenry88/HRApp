<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Monthly Duties Timetable</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Etak Logistics" class="logo">
        </div>
        <ul class="navbar-menu">
            <li><a href="{{ url_for('index') }}">Home</a></li>
            <li><a href="{{ url_for('timetable.timetable_form') }}" class="active">Monthly Timetable</a></li>
            <li><a href="{{ url_for('hr_calendar.display_calendar') }}">HR Calendar</a></li>
            <li><a href="{{ url_for('logout') }}">Logout</a></li>
        </ul>
    </nav>
    <div class="container">
        <h1>Staff Monthly Duties Timetable</h1>
        <form class="form-container" id="pdfForm">
            <label for="department">Department:</label>
            <select name="department" id="department">
                {% for dept in departments %}
                <option value="{{ dept }}" {% if dept == department %}selected{% endif %}>{{ dept }}</option>
                {% endfor %}
            </select>

            <label for="month_year">Select Month and Year:</label>
            <input type="month" id="month_year" name="month_year" value="{{ month_year }}" required>

            <label for="filename">PDF Filename:</label>
            <input type="text" name="filename" id="filename" value="staff_duties_timetable.pdf">

            <label for="include_toc"><input type="checkbox" id="include_toc" name="include_toc" {% if not is_mobile %}checked{% endif %}> Include Table of Contents</label>

            <button type="button" id="generateBtn" onclick="generatePDF()">Generate PDF</button>
            <!-- Hidden inputs for PDF generation -->
            <input type="hidden" name="year" value="{{ year }}">
            <input type="hidden" name="month" value="{{ month }}">
        </form>

        <!-- Loading Spinner Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
            <p>Generating PDF...</p>
        </div>
    </div>
    <script>
        // Update filename based on selected month and year
        document.getElementById('month_year').addEventListener('change', function() {
            const monthYear = this.value;
            if (monthYear) {
                const [year, month] = monthYear.split('-');
                const yy = year.slice(-2);
                document.getElementById('filename').value = `staff_duties_timetable_${yy}${month}.pdf`;
            } else {
                document.getElementById('filename').value = 'staff_duties_timetable.pdf';
            }
        });

        // Function to generate PDF using AJAX
        async function generatePDF() {
            const form = document.getElementById('pdfForm');
            const generateBtn = document.getElementById('generateBtn');
            const loadingOverlay = document.getElementById('loadingOverlay');

            // Disable the button and show loading spinner
            generateBtn.disabled = true;
            generateBtn.innerText = 'Generating...';
            loadingOverlay.style.display = 'flex';

            try {
                // Collect form data
                const formData = new FormData(form);

                // Send AJAX request to generate PDF
                const response = await fetch('{{ url_for("timetable.generate_pdf_route") }}', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Failed to generate PDF: ' + response.statusText);
                }

                // Get the filename from the form
                const filename = formData.get('filename') || 'staff_duties_timetable.pdf';

                // Get the response as a blob
                const blob = await response.blob();

                // Create a temporary URL for the blob and trigger download
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);

                // Reset the button and hide the spinner
                generateBtn.disabled = false;
                generateBtn.innerText = 'Generate PDF';
                loadingOverlay.style.display = 'none';
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('An error occurred while generating the PDF: ' + error.message);
                // Reset the button and hide the spinner on error
                generateBtn.disabled = false;
                generateBtn.innerText = 'Generate PDF';
                loadingOverlay.style.display = 'none';
            }
        }
    </script>
</body>
</html>