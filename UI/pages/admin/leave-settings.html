<!DOCTYPE html>
<!-- 
    Leave Settings & Reports - HR Leave Management System
    Description: Admin page for configuring leave types and generating reports
    Features:
    - Manage leave types (Annual, Sick, Personal, Study)
    - Configure default allocations
    - Manage public holidays
    - Generate utilization reports
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leave Settings - HR Leave Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../css/styles.css">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-sidebar-header">
                <i class="fas fa-calendar-check text-[#00AFB9] text-2xl mr-2"></i>
                <span class="admin-logo">HR System</span>
            </div>
            
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="sidebar-nav-item">
                    <i class="fas fa-home"></i>
                    <span data-i18n="admin.dashboard">Dashboard</span>
                </a>
                <a href="approve-leaves.html" class="sidebar-nav-item">
                    <i class="fas fa-check-circle"></i>
                    <span data-i18n="admin.approveLeaves">Approve Leaves</span>
                </a>
                <a href="compensatory-leave.html" class="sidebar-nav-item">
                    <i class="fas fa-plus-circle"></i>
                    <span data-i18n="admin.compensatory">Compensatory Leave</span>
                </a>
                <a href="manage-employees.html" class="sidebar-nav-item">
                    <i class="fas fa-users"></i>
                    <span data-i18n="admin.manageEmployees">Manage Employees</span>
                </a>
                <a href="leave-settings.html" class="sidebar-nav-item active">
                    <i class="fas fa-cog"></i>
                    <span data-i18n="admin.settings">Leave Settings</span>
                </a>
                <a href="blackout-dates.html" class="sidebar-nav-item">
                    <i class="fas fa-ban"></i>
                    <span data-i18n="admin.blackoutDates">Blackout Dates</span>
                </a>
                <a href="reports.html" class="sidebar-nav-item">
                    <i class="fas fa-chart-bar"></i>
                    <span data-i18n="admin.reports">Reports</span>
                </a>
                
                <div class="mt-auto pt-4 border-t border-white border-opacity-10">
                    <a href="../login.html" onclick="logout()" class="sidebar-nav-item">
                        <i class="fas fa-sign-out-alt"></i>
                        <span data-i18n="nav.logout">Logout</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="admin-content">
            <!-- Top Header -->
            <header class="admin-header">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold" data-i18n="admin.settings">Leave Settings & Reports</h1>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Language Switcher -->
                    <div class="lang-switcher relative">
                        <div class="flex items-center cursor-pointer" onclick="toggleLangDropdown()">
                            <i class="fas fa-globe text-white"></i>
                            <span class="current-lang ml-1 text-sm" id="currentLangText">EN</span>
                        </div>
                        <div class="dropdown-menu" id="langDropdown">
                            <div class="dropdown-item" data-lang="en" onclick="switchLanguage('en')">
                                English
                            </div>
                            <div class="dropdown-item" data-lang="zh" onclick="switchLanguage('zh')">
                                繁體中文
                            </div>
                        </div>
                    </div>
                    
                    <!-- Admin Profile -->
                    <div class="flex items-center">
                        <div class="text-right mr-3">
                            <p class="text-sm font-medium text-white">Administrator</p>
                            <p class="text-xs text-white opacity-80">admin</p>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-white bg-opacity-20 flex items-center justify-center">
                            <i class="fas fa-user-shield text-white"></i>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content Area -->
            <main class="admin-main">
                <!-- Tab Navigation -->
                <div class="mb-6 flex gap-4 border-b">
                    <button onclick="showTab('leaveTypes')" id="tab-leaveTypes" class="tab-btn active px-4 py-2 font-medium text-[#00AFB9] border-b-2 border-[#00AFB9]">
                        <i class="fas fa-list mr-2"></i>Leave Types
                    </button>
                    <button onclick="showTab('holidays')" id="tab-holidays" class="tab-btn px-4 py-2 font-medium text-gray-600 hover:text-[#00AFB9]">
                        <i class="fas fa-calendar-day mr-2"></i>Public Holidays
                    </button>
                    <button onclick="showTab('reports')" id="tab-reports" class="tab-btn px-4 py-2 font-medium text-gray-600 hover:text-[#00AFB9]">
                        <i class="fas fa-chart-bar mr-2"></i>Reports
                    </button>
                </div>

                <!-- Leave Types Tab -->
                <div id="content-leaveTypes" class="tab-content">
                    <div class="admin-card mb-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-gray-800">Leave Types Configuration</h3>
                            <button onclick="showAddLeaveTypeModal()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors font-bold shadow-md">
                                <i class="fas fa-plus mr-2"></i>Add Leave Type
                            </button>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <!-- Annual Leave Card -->
                            <div class="p-5 border border-gray-200 rounded-lg bg-[rgba(0,175,185,0.05)]">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 rounded-full bg-[#00AFB9] bg-opacity-20 flex items-center justify-center mr-3">
                                            <i class="fas fa-calendar-alt text-[#00AFB9] text-xl"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-medium text-gray-800">Annual Leave</h4>
                                            <p class="text-xs text-gray-600">年假</p>
                                        </div>
                                    </div>
                                    <button onclick="editLeaveType('annual')" class="text-[#00AFB9] hover:text-[#009ba3]">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Default Days:</span>
                                        <span class="font-medium">20 days/year</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Requires Approval:</span>
                                        <span class="text-green-600"><i class="fas fa-check"></i> Yes</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Status:</span>
                                        <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Active</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Sick Leave Card -->
                            <div class="p-5 border border-gray-200 rounded-lg bg-[rgba(255,107,107,0.05)]">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 rounded-full bg-[#FF6B6B] bg-opacity-20 flex items-center justify-center mr-3">
                                            <i class="fas fa-procedures text-[#FF6B6B] text-xl"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-medium text-gray-800">Sick Leave</h4>
                                            <p class="text-xs text-gray-600">病假</p>
                                        </div>
                                    </div>
                                    <button onclick="editLeaveType('sick')" class="text-[#00AFB9] hover:text-[#009ba3]">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Default Days:</span>
                                        <span class="font-medium">10 days/year</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Requires Approval:</span>
                                        <span class="text-green-600"><i class="fas fa-check"></i> Yes</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Status:</span>
                                        <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Active</span>
                                    </div>
                                </div>
                            </div>

                            
                        </div>
                    </div>
                </div>

                <!-- Holidays Tab -->
                <div id="content-holidays" class="tab-content hidden">
                    <div class="admin-card">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-gray-800">Public Holidays</h3>
                            <div class="flex items-center gap-2 text-sm text-gray-600">
                                <span>Source:</span>
                                <a href="https://www.1823.gov.hk/common/ical/en.json" target="_blank" class="text-[#00AFB9] underline">1823 EN</a>
                                <a href="https://www.1823.gov.hk/common/ical/tc.json" target="_blank" class="text-[#00AFB9] underline">1823 繁</a>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50 border-b-2 border-gray-200">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-600">Date</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-600">Holiday Name (EN)</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-600">Holiday Name (中文)</th>
                                    </tr>
                                </thead>
                                <tbody id="holidaysTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div id="content-reports" class="tab-content hidden">
                    <div class="admin-card mb-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Leave Utilization Report</h3>
                        
                        <!-- Report Filters -->
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Date Range</label>
                                <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#00AFB9] focus:border-[#00AFB9]">
                                    <option>Last 30 Days</option>
                                    <option>Last 3 Months</option>
                                    <option>This Year</option>
                                    <option>Custom Range</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Department</label>
                                <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#00AFB9] focus:border-[#00AFB9]">
                                    <option>All Departments</option>
                                    <option>Marketing</option>
                                    <option>Engineering</option>
                                    <option>Sales</option>
                                    <option>HR</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Leave Type</label>
                                <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#00AFB9] focus:border-[#00AFB9]">
                                    <option>All Types</option>
                                    <option>Annual Leave</option>
                                    <option>Sick Leave</option>
                                    
                                </select>
                            </div>
                        </div>

                        <button class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors font-bold shadow-md">
                            <i class="fas fa-chart-bar mr-2"></i>Generate Report
                        </button>
                    </div>

                    <!-- Sample Report Stats -->
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="admin-card bg-gradient-to-br from-blue-50 to-blue-100">
                            <p class="text-sm text-gray-600 mb-1">Total Requests</p>
                            <p class="text-3xl font-bold text-blue-600">156</p>
                        </div>
                        <div class="admin-card bg-gradient-to-br from-green-50 to-green-100">
                            <p class="text-sm text-gray-600 mb-1">Approved</p>
                            <p class="text-3xl font-bold text-green-600">142</p>
                        </div>
                        <div class="admin-card bg-gradient-to-br from-yellow-50 to-yellow-100">
                            <p class="text-sm text-gray-600 mb-1">Pending</p>
                            <p class="text-3xl font-bold text-yellow-600">8</p>
                        </div>
                        <div class="admin-card bg-gradient-to-br from-red-50 to-red-100">
                            <p class="text-sm text-gray-600 mb-1">Rejected</p>
                            <p class="text-3xl font-bold text-red-600">6</p>
                        </div>
                    </div>

                    <!-- Chart Placeholder -->
                    <div class="admin-card">
                        <h4 class="font-medium text-gray-800 mb-4">Leave Utilization by Month</h4>
                        <div class="h-64 bg-gray-100 rounded flex items-center justify-center">
                            <div class="text-center text-gray-500">
                                <i class="fas fa-chart-line text-5xl mb-3"></i>
                                <p>Chart visualization would appear here</p>
                                <p class="text-xs">(In production: Use Chart.js or similar library)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="../../js/app.js"></script>
    <script>
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if admin
            const userRole = localStorage.getItem('userRole');
            if (userRole !== 'admin') {
                alert('Access denied. Admin privileges required.');
                window.location.href = '../login.html';
                return;
            }

            // Load and render holidays
            loadAndRenderHolidays();
        });

        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'text-[#00AFB9]', 'border-b-2', 'border-[#00AFB9]');
                btn.classList.add('text-gray-600');
            });

            // Show selected tab
            document.getElementById('content-' + tabName).classList.remove('hidden');

            // Add active class to selected button
            const activeBtn = document.getElementById('tab-' + tabName);
            activeBtn.classList.add('active', 'text-[#00AFB9]', 'border-b-2', 'border-[#00AFB9]');
            activeBtn.classList.remove('text-gray-600');
        }

        // Modal functions
        function showAddLeaveTypeModal() {
            showAlert('Add Leave Type functionality', 'info');
        }

        function editLeaveType(type) {
            showAlert('Edit ' + type + ' leave type', 'info');
        }

        function showAddHolidayModal() {
            showAlert('Add Holiday functionality', 'info');
        }

        // Load holidays from official JSON and render bilingual table
        async function loadAndRenderHolidays() {
            try {
                await ensureHolidaysLoaded();
                const en = await fetchHKHolidays('en');
                const zh = await fetchHKHolidays('zh');
                const zhMap = new Map(zh.map(h => [h.date, h.name]));

                // Sort by date ascending
                en.sort((a,b) => a.date.localeCompare(b.date));

                const tbody = document.getElementById('holidaysTableBody');
                tbody.innerHTML = en.map(h => {
                    const nameZh = zhMap.get(h.date) || '';
                    const display = formatDisplayDate(h.date);
                    return `
                        <tr class="border-b border-gray-100">
                            <td class="px-4 py-3 text-sm">${display}</td>
                            <td class="px-4 py-3 text-sm">${escapeHtml(h.name)}</td>
                            <td class="px-4 py-3 text-sm">${escapeHtml(nameZh)}</td>
                        </tr>
                    `;
                }).join('');
            } catch (e) {
                showAlert('Failed to load holidays from 1823.gov.hk', 'error');
            }
        }

        function formatDisplayDate(iso) {
            const date = new Date(iso);
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString(currentLang === 'zh' ? 'zh-TW' : 'en-US', options);
        }

        function escapeHtml(str) {
            return (str || '').replace(/[&<>"']/g, function(m) {
                return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]);
            });
        }

        // Re-render when language changes (date formatting)
        window.addEventListener('languageChanged', () => {
            loadAndRenderHolidays();
        });

        // Logout
        function logout() {
            localStorage.removeItem('userRole');
            localStorage.removeItem('username');
            localStorage.removeItem('rememberMe');
        }

        // Alert function
        function showAlert(message, type) {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };

            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed top-20 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-lg shadow-lg ${colors[type] || colors.info} text-white text-sm font-medium`;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
    </script>
</body>
</html>
