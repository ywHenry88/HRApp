<!DOCTYPE html>
<!-- 
    Version: 2.3.0
    Employee Dashboard - HR Leave Management System (Redesigned)
    Description: Professional, clean, and organized mobile-first dashboard
    Features:
    - Modern gradient welcome card with employee info
    - Clear leave summary with visual hierarchy
    - Organized annual and sick leave cards
    - Professional pending requests display
    - Enhanced quick action buttons with hover effects
    - Team calendar view with month navigation
    - Consistent spacing and visual design
    - Bilingual support (EN/繁體中文)
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - HR Leave Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../css/styles.css">
</head>
<body>
    <div class="page-container">
        <!-- Top Header -->
        <div class="top-header">
            <div class="flex items-center">
                <h1 class="text-base font-semibold" data-i18n="dashboard.title">Home</h1>
                <span class="mx-2 text-white text-opacity-50">|</span>
                <span class="text-xs text-white text-opacity-80" id="currentDate">Oct 28, 2025</span>
            </div>
            <div class="header-right">
                <!-- Language Switcher -->
                <div class="lang-switcher relative">
                    <div class="flex items-center cursor-pointer" onclick="toggleLangDropdown()">
                        <i class="fas fa-globe text-white text-sm"></i>
                        <span class="current-lang ml-1 text-xs" id="currentLangText">EN</span>
                    </div>
                    <div class="dropdown-menu" id="langDropdown">
                        <div class="dropdown-item" data-lang="en" onclick="switchLanguage('en')">
                            English
                        </div>
                        <div class="dropdown-item" data-lang="zh" onclick="switchLanguage('zh')">
                            繁體中文
                        </div>
                    </div>
                </div>
                <!-- User Profile Icon -->
                <div class="relative ml-3">
                    <button onclick="toggleProfileMenu()" class="flex items-center focus:outline-none">
                        <div class="w-8 h-8 rounded-full bg-white bg-opacity-20 flex items-center justify-center">
                            <i class="fas fa-user text-white text-xs"></i>
                        </div>
                    </button>
                    <div class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-50" id="profileMenu">
                        <a href="profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            <i class="fas fa-user mr-2"></i><span data-i18n="nav.profile">Profile</span>
                        </a>
                        <a href="#" onclick="logout()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            <i class="fas fa-sign-out-alt mr-2"></i><span data-i18n="nav.logout">Logout</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <main class="page-content p-4">
            <!-- Welcome Section -->
            <div class="mb-4">
                <div class="bg-gradient-to-r from-[#00AFB9] to-[#4BCBD6] p-5 rounded-xl shadow-md text-white">
                    <h2 class="text-lg font-bold mb-3">
                        <span data-i18n="dashboard.welcome">Welcome</span>, <span id="employeeName">Wong Pak Kun</span>
                    </h2>
                    <div class="grid grid-cols-2 gap-3 text-xs">
                        <div class="bg-white bg-opacity-20 p-2 rounded-lg">
                            <div class="opacity-90 mb-1">Employee Code</div>
                            <div class="font-semibold text-sm" id="employeeCode">L003</div>
                        </div>
                        <div class="bg-white bg-opacity-20 p-2 rounded-lg">
                            <div class="opacity-90 mb-1">Hire Date</div>
                            <div class="font-semibold text-sm" id="hireDate">01/04/1995</div>
                        </div>
                        <div class="col-span-2 bg-white bg-opacity-20 p-2 rounded-lg">
                            <div class="opacity-90 mb-1">Current Period (當前服務期間)</div>
                            <div class="font-semibold text-sm" id="currentPeriod">2025-04-01 → 2026-03-31</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leave Summary Section -->
            <div class="mb-4">
                <div class="bg-white p-4 rounded-xl shadow-md">
                    <h3 class="text-sm font-semibold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-chart-bar text-[#00AFB9] mr-2"></i>
                        Leave Summary
                    </h3>
                    
                    <!-- Annual Leave -->
                    <div class="mb-4 p-4 rounded-lg bg-gradient-to-br from-[#00AFB9]/5 to-[#00AFB9]/10 border border-[#00AFB9]/20">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-[#00AFB9] flex items-center justify-center mr-3">
                                    <i class="fas fa-calendar-alt text-white text-sm"></i>
                                </div>
                                <span class="text-sm font-semibold text-gray-800">Annual Leave</span>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-[#00AFB9]">5</div>
                                <div class="text-[10px] text-gray-500">days applied</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="bg-white p-2 rounded-lg">
                                <div class="text-gray-600 mb-1">Granted (按年授予)</div>
                                <div class="font-bold text-[#00AFB9]">11 days</div>
                            </div>
                            <div class="bg-white p-2 rounded-lg">
                                <div class="text-gray-600 mb-1">Estimate (按比例)</div>
                                <div class="font-bold text-[#00AFB9]">18.8 days</div>
                            </div>
                        </div>
                        
                        <div class="mt-2 text-[10px] text-gray-600 bg-white/50 p-2 rounded">
                            <i class="fas fa-info-circle text-[#00AFB9] mr-1"></i>
                            5 days applied in current period (不含以薪代假)
                        </div>
                    </div>
                    
                    <!-- Sick Leave -->
                    <div class="p-4 rounded-lg bg-gradient-to-br from-[#FF6B6B]/5 to-[#FF6B6B]/10 border border-[#FF6B6B]/20">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-[#FF6B6B] flex items-center justify-center mr-3">
                                    <i class="fas fa-procedures text-white text-sm"></i>
                                </div>
                                <div>
                                    <div class="text-sm font-semibold text-gray-800">Sick Leave</div>
                                    <div class="text-xs text-gray-600">1 / 4 days used</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-[#FF6B6B]">3</div>
                                <div class="text-[10px] text-gray-500">days remaining</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Policy Info -->
                    <div class="mt-3 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                        <div class="text-[11px] text-blue-900 leading-relaxed">
                            <strong>Policy:</strong> Annual leave has no expiry. Split/pay-in-lieu handled case-by-case.
                            <br/>
                            <span class="text-blue-800">年假不設到期。分拆／以薪代假由管理員逐案處理。</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pending Requests Summary -->
            <div class="mb-4">
                <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-yellow-400">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-12 h-12 rounded-full bg-yellow-50 flex items-center justify-center mr-3">
                                <i class="fas fa-clock text-yellow-600 text-lg"></i>
                            </div>
                            <div>
                                <div class="text-sm font-semibold text-gray-800">Pending Requests</div>
                                <div class="text-xs text-gray-600">Awaiting approval</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold text-yellow-600">2</div>
                            <a href="leave-history.html" class="text-xs text-[#00AFB9] hover:underline flex items-center justify-end mt-1">
                                View all <i class="fas fa-arrow-right ml-1"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="mb-4">
                <div class="grid grid-cols-2 gap-3">
                    <a href="leave-request-multi.html" class="bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white p-5 rounded-xl shadow-lg flex flex-col items-center justify-center transition-all transform hover:scale-105">
                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center mb-2">
                            <i class="fas fa-calendar-plus text-xl"></i>
                        </div>
                        <span class="text-sm font-semibold">Request Leave</span>
                    </a>
                    <a href="leave-history.html" class="bg-white hover:bg-gray-50 border-2 border-gray-200 text-gray-800 p-5 rounded-xl shadow-md flex flex-col items-center justify-center transition-all transform hover:scale-105">
                        <div class="w-12 h-12 bg-[#00AFB9]/10 rounded-full flex items-center justify-center mb-2">
                            <i class="fas fa-history text-xl text-[#00AFB9]"></i>
                        </div>
                        <span class="text-sm font-semibold">View History</span>
                    </a>
                </div>
            </div>

            <!-- Team Schedule Calendar -->
            <div class="mb-20">
                <div class="bg-white p-4 rounded-xl shadow-md">
                    <h3 class="text-sm font-semibold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-users text-[#00AFB9] mr-2"></i>
                        Team Schedule
                    </h3>
                    
                    <!-- Month Picker -->
                    <div class="month-picker">
                        <div class="month-picker-title" id="currentMonth">October 2025</div>
                        <div class="month-picker-nav">
                            <button class="month-picker-btn" onclick="changeMonth(-1)">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="month-picker-btn" onclick="changeMonth(1)">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Calendar Table -->
                    <div class="overflow-x-auto">
                        <table class="schedule-calendar">
                            <thead>
                                <tr>
                                    <th data-i18n="calendar.sun">Sun</th>
                                    <th data-i18n="calendar.mon">Mon</th>
                                    <th data-i18n="calendar.tue">Tue</th>
                                    <th data-i18n="calendar.wed">Wed</th>
                                    <th data-i18n="calendar.thu">Thu</th>
                                    <th data-i18n="calendar.fri">Fri</th>
                                    <th data-i18n="calendar.sat">Sat</th>
                                </tr>
                            </thead>
                            <tbody id="calendarBody">
                                <!-- Calendar will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="dashboard.html" class="active">
                <i class="fas fa-home"></i>
                <span data-i18n="nav.home">Home</span>
            </a>
            <a href="leave-request-multi.html">
                <i class="fas fa-calendar-plus"></i>
                <span data-i18n="nav.request">Request</span>
            </a>
            <a href="leave-history.html">
                <i class="fas fa-history"></i>
                <span data-i18n="nav.history">History</span>
            </a>
            <a href="profile.html">
                <i class="fas fa-user"></i>
                <span data-i18n="nav.profile">Profile</span>
            </a>
        </nav>
    </div>

    <script src="../../js/app.js"></script>
    <script>
        // Profile menu toggle
        function toggleProfileMenu() {
            const menu = document.getElementById('profileMenu');
            menu.classList.toggle('hidden');
        }

        // Close profile menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('profileMenu');
            const target = event.target;
            if (!target.closest('.relative') && !menu.classList.contains('hidden')) {
                menu.classList.add('hidden');
            }
        });

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('userRole');
                localStorage.removeItem('username');
                localStorage.removeItem('rememberMe');
                window.location.href = '../login.html';
            }
        }

        // Initialize current date
        function initializeDate() {
            const dateElement = document.getElementById('currentDate');
            const now = new Date();
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            dateElement.textContent = now.toLocaleDateString('en-US', options);
        }

        // Calendar functions
        let currentCalendarMonth = new Date().getMonth();
        let currentCalendarYear = new Date().getFullYear();

        function generateCalendar(month, year) {
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Sample leave data (in production, this would come from API)
            const leaveData = {
                '2025-10-15': [{ name: '徐潔琛', type: 'annual' }],
                '2025-10-16': [{ name: '徐潔琛', type: 'annual' }, { name: '鄭國峰', type: 'sick' }],
                '2025-10-22': [{ name: '李嘉欣', type: 'personal' }],
                '2025-10-23': [{ name: '李嘉欣', type: 'personal' }]
            };

            // Holidays (from 1823 JSON, loaded at runtime)
            // Use window.__dashHolidays populated by loader

            let date = 1;
            let nextMonthDate = 1;

            for (let i = 0; i < 6; i++) {
                const row = document.createElement('tr');

                for (let j = 0; j < 7; j++) {
                    const cell = document.createElement('td');

                    if (i === 0 && j < firstDay) {
                        // Empty cells before month starts
                        cell.classList.add('text-gray-300');
                        const prevMonthDays = new Date(year, month, 0).getDate();
                        cell.innerHTML = `<span class="date-number">${prevMonthDays - firstDay + j + 1}</span>`;
                    } else if (date > daysInMonth) {
                        // Empty cells after month ends
                        cell.classList.add('text-gray-300');
                        cell.innerHTML = `<span class="date-number">${nextMonthDate}</span>`;
                        nextMonthDate++;
                    } else {
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                        
                        cell.innerHTML = `<span class="date-number">${date}</span>`;

                        // Check if holiday (fast year map)
                        const lang = (typeof currentLang !== 'undefined' && currentLang === 'zh') ? 'zh' : 'en';
                        const hname = (typeof getHolidayNameFast === 'function') ? getHolidayNameFast(dateStr, lang) : null;
                        if (hname) {
                            cell.classList.add('holiday');
                            cell.innerHTML += `<span class="special-day">${hname}</span>`;
                        }

                        // Check if anyone on leave
                        if (leaveData[dateStr]) {
                            const eventsHtml = leaveData[dateStr].map(leave => 
                                `<div class="event-item event-${leave.type}">${leave.name}</div>`
                            ).join('');
                            cell.innerHTML += `<div class="event">${eventsHtml}</div>`;
                        }

                        // Highlight today
                        const today = new Date();
                        if (date === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                            cell.style.backgroundColor = '#f0fafb';
                            cell.style.border = '2px solid #00AFB9';
                        }

                        date++;
                    }

                    row.appendChild(cell);
                }

                calendarBody.appendChild(row);

                // Break if we've filled all days
                if (date > daysInMonth && nextMonthDate > 7) {
                    break;
                }
            }

            // Update month title
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
        }

        function changeMonth(delta) {
            currentCalendarMonth += delta;
            if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            } else if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            }
            generateCalendar(currentCalendarMonth, currentCalendarYear);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Check if logged in
            const username = localStorage.getItem('username');
            if (!username) {
                window.location.href = '../login.html';
                return;
            }

            // Set employee name (Real data from SQL Server tb_Users)
            // Default to L003 (Wong Pak Kun / 黃柏根) - exists in database
            const staffCode = localStorage.getItem('staffCode') || 'L003';
            const employeeName = staffCode === 'L003' ? 'Wong Pak Kun (黃柏根)' : 
                                 staffCode === 'ADMIN001' ? 'System Administrator (系統管理員)' :
                                 'Employee';
            document.getElementById('employeeName').textContent = employeeName;
            document.getElementById('employeeCode').textContent = staffCode;

            // Initialize date
            initializeDate();

            // Render immediately using cached year map if present, then ensure load and re-render
            try { generateCalendar(currentCalendarMonth, currentCalendarYear); } catch (_) {}
            loadHolidaysThenRender();
        });

        async function loadHolidaysThenRender() {
            try {
                const lang = (typeof currentLang !== 'undefined' && currentLang === 'zh') ? 'zh' : 'en';
                const list = await fetchHKHolidays(lang); // fetch only current language for speed
                const map = {};
                list.forEach(h => { map[h.date] = h.name; });

                // Inject into closure for generateCalendar via window-scoped variable
                window.__dashHolidays = map;
            } catch (e) {
                window.__dashHolidays = {};
            }
            // Re-render with holidays now available
            generateCalendar(currentCalendarMonth, currentCalendarYear);
        }

        // Re-render when language changes to update holiday names
        window.addEventListener('languageChanged', () => {
            loadHolidaysThenRender();
        });
    </script>
</body>
</html>
