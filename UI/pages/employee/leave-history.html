<!DOCTYPE html>
<!-- 
    Leave History - HR Leave Management System
    Description: View and manage leave request history
    Features:
    - Filter by status (All/Pending/Approved/Rejected)
    - Filter by leave type
    - View request details
    - Edit/Cancel pending requests
    - Status badges with color coding
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leave History - HR Leave Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../css/styles.css">
    <style>
        .filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            border: 1px solid #e5e7eb;
            background: white;
        }
        .filter-btn.active {
            background-color: #00AFB9;
            color: white;
            border-color: #00AFB9;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Top Header -->
        <div class="top-header">
            <div class="flex items-center">
                <a href="dashboard.html" class="mr-3">
                    <i class="fas fa-arrow-left text-white"></i>
                </a>
                <h1 class="text-lg font-bold" data-i18n="history.title">Leave History</h1>
            </div>
            <div class="header-right">
                <!-- Language Switcher -->
                <div class="lang-switcher relative">
                    <div class="flex items-center cursor-pointer" onclick="toggleLangDropdown()">
                        <i class="fas fa-globe text-white"></i>
                        <span class="current-lang ml-1 text-sm" id="currentLangText">EN</span>
                            </div>
                    <div class="dropdown-menu" id="langDropdown">
                        <div class="dropdown-item" data-lang="en" onclick="switchLanguage('en')">
                            English
                        </div>
                        <div class="dropdown-item" data-lang="zh" onclick="switchLanguage('zh')">
                            繁體中文
                        </div>
                    </div>
                </div>
                            </div>
                        </div>

        <main class="page-content p-4">
            <!-- Filters -->
            <div class="mb-4">
                <h3 class="text-xs font-medium text-gray-600 mb-2" data-i18n="history.filterByStatus">Filter by Status</h3>
                <div class="flex gap-2 flex-wrap">
                    <button class="filter-btn active" data-status="all" onclick="filterByStatus('all')">
                        <span data-i18n="history.all">All</span>
                    </button>
                    <button class="filter-btn" data-status="pending" onclick="filterByStatus('pending')">
                        <span data-i18n="status.pending">Pending</span>
                    </button>
                    <button class="filter-btn" data-status="approved" onclick="filterByStatus('approved')">
                        <span data-i18n="status.approved">Approved</span>
                                </button>
                    <button class="filter-btn" data-status="rejected" onclick="filterByStatus('rejected')">
                        <span data-i18n="status.rejected">Rejected</span>
                                </button>
                            </div>
                        </div>

            <!-- Leave Type Filter -->
            <div class="mb-6">
                <h3 class="text-xs font-medium text-gray-600 mb-2" data-i18n="history.filterByType">Filter by Type</h3>
                <select id="typeFilter" onchange="filterByType()"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#00AFB9] focus:border-[#00AFB9]">
                    <option value="all">All Types</option>
                    <option value="annual">Annual Leave (年假)</option>
                    <option value="sick">Sick Leave (病假)</option>
                    
                </select>
            </div>

            <!-- Leave Requests List -->
            <div id="leaveRequestsList" class="space-y-4">
                <!-- Requests will be populated by JavaScript -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden text-center py-12">
                <i class="fas fa-inbox text-gray-300 text-5xl mb-4"></i>
                <p class="text-gray-500" data-i18n="history.noRequests">No leave requests found</p>
                    </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="dashboard.html">
                <i class="fas fa-home"></i>
                <span data-i18n="nav.home">Home</span>
            </a>
            <a href="leave-request-multi.html">
                <i class="fas fa-calendar-plus"></i>
                <span data-i18n="nav.request">Request</span>
            </a>
            <a href="leave-history.html" class="active">
                <i class="fas fa-history"></i>
                <span data-i18n="nav.history">History</span>
            </a>
            <a href="profile.html">
                <i class="fas fa-user"></i>
                <span data-i18n="nav.profile">Profile</span>
            </a>
        </nav>
                </div>

    <script src="../../js/app.js"></script>
    <script>
        // Sample leave requests data (in production, from API)
        const leaveRequests = [
            {
                id: 1,
                type: 'annual',
                typeName: 'Annual Leave',
                typeNameZh: '年假',
                startDate: '2025-11-15',
                endDate: '2025-11-19',
                days: 5,
                reason: 'Family vacation',
                status: 'pending',
                submittedDate: '2025-10-18',
                approvedDate: null,
                approver: null,
                comments: null
            },
            {
                id: 2,
                type: 'sick',
                typeName: 'Sick Leave',
                typeNameZh: '病假',
                startDate: '2025-10-10',
                endDate: '2025-10-11',
                days: 2,
                reason: 'Medical checkup',
                status: 'approved',
                submittedDate: '2025-10-08',
                approvedDate: '2025-10-09',
                approver: 'Admin',
                comments: 'Approved. Get well soon!',
                partialApproval: false,  // v2.0: Full approval
                approvedDays: 2,
                requestedDates: ['2025-10-10', '2025-10-11'],
                approvedDates: ['2025-10-10', '2025-10-11']
            },
            
            {
                id: 5,
                type: 'annual',
                typeName: 'Annual Leave',
                typeNameZh: '年假',
                startDate: '2025-10-25',
                endDate: '2025-10-26',
                days: 2,
                reason: 'Extended weekend',
                status: 'pending',
                submittedDate: '2025-10-19',
                approvedDate: null,
                approver: null,
                comments: null
            }
        ];

        // Current filters
        let currentStatusFilter = 'all';
        let currentTypeFilter = 'all';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Check if logged in
            const username = localStorage.getItem('username');
            if (!username) {
                window.location.href = '../login.html';
                return;
            }

            // Render leave requests
            renderLeaveRequests();
        });

        // Render leave requests
        function renderLeaveRequests() {
            const container = document.getElementById('leaveRequestsList');
            const emptyState = document.getElementById('emptyState');

            // Filter requests
            let filteredRequests = leaveRequests.filter(request => {
                const statusMatch = currentStatusFilter === 'all' || request.status === currentStatusFilter;
                const typeMatch = currentTypeFilter === 'all' || request.type === currentTypeFilter;
                return statusMatch && typeMatch;
            });

            // Sort by submitted date (newest first)
            filteredRequests.sort((a, b) => new Date(b.submittedDate) - new Date(a.submittedDate));

            // Clear container
            container.innerHTML = '';

            if (filteredRequests.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            } else {
                emptyState.classList.add('hidden');
            }

            // Render each request
            filteredRequests.forEach(request => {
                const card = createRequestCard(request);
                container.appendChild(card);
            });
        }

        // Create request card
        function createRequestCard(request) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-md overflow-hidden';

            // Status colors
            const statusColors = {
                pending: { bg: '#FEF3C7', text: '#92400E', icon: 'clock' },
                approved: { bg: '#D1FAE5', text: '#065F46', icon: 'check-circle' },
                rejected: { bg: '#FEE2E2', text: '#B91C1C', icon: 'times-circle' }
            };

            // Leave type colors
            const typeColors = {
                annual: '#00AFB9',
                sick: '#FF6B6B',
                personal: '#FFD166',
                study: '#06D6A0'
            };

            const status = statusColors[request.status];
            const typeColor = typeColors[request.type];

            card.innerHTML = `
                <!-- Header with type and status -->
                <div class="p-4 border-b border-gray-200" style="border-left: 4px solid ${typeColor}">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3" style="background-color: ${typeColor}20">
                                <i class="fas fa-calendar-alt" style="color: ${typeColor}"></i>
                            </div>
                            <div>
                                <h3 class="font-medium text-gray-900">${request.typeName}</h3>
                                <p class="text-xs text-gray-500">${request.typeNameZh}</p>
                            </div>
                        </div>
                        <div class="px-3 py-1 rounded-full text-xs font-medium" style="background-color: ${status.bg}; color: ${status.text}">
                            <i class="fas fa-${status.icon} mr-1"></i>${request.status.charAt(0).toUpperCase() + request.status.slice(1)}
                        </div>
                    </div>
                </div>

                <!-- Details -->
                <div class="p-4 space-y-3">
                    <div class="flex items-center text-sm">
                        <i class="fas fa-calendar text-gray-400 w-5"></i>
                        <span class="text-gray-700">${formatDate(request.startDate)} - ${formatDate(request.endDate)}</span>
                            </div>
                    <div class="flex items-center text-sm">
                        <i class="fas fa-clock text-gray-400 w-5"></i>
                        <span class="text-gray-700">${request.days} ${request.days === 1 ? 'day' : 'days'} requested</span>
                        ${request.status === 'approved' && request.partialApproval ? `
                            <span class="ml-2 px-2 py-0.5 bg-orange-100 text-orange-700 text-xs rounded-full font-medium">
                                <i class="fas fa-info-circle mr-1"></i>Only ${request.approvedDays} approved
                            </span>
                        ` : ''}
                    </div>
                    ${request.reason ? `
                    <div class="flex items-start text-sm">
                        <i class="fas fa-comment-alt text-gray-400 w-5 mt-1"></i>
                        <span class="text-gray-700">${request.reason}</span>
                </div>
                    ` : ''}
                    <div class="flex items-center text-xs text-gray-500">
                        <i class="fas fa-paper-plane w-5"></i>
                        <span>Submitted: ${formatDate(request.submittedDate)}</span>
                            </div>
                    ${request.status !== 'pending' ? `
                    <div class="flex items-center text-xs text-gray-500">
                        <i class="fas fa-user-check w-5"></i>
                        <span>${request.status.charAt(0).toUpperCase() + request.status.slice(1)} by ${request.approver} on ${formatDate(request.approvedDate)}</span>
                        </div>
                    ` : ''}
                    ${request.comments ? `
                    <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded">
                        <p class="text-xs text-blue-800"><strong>Admin Comment:</strong> ${request.comments}</p>
                    </div>
                    ` : ''}
                    ${request.status === 'approved' && request.partialApproval && request.requestedDates && request.approvedDates ? `
                    <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded">
                        <p class="text-xs font-medium text-yellow-800 mb-2">
                            <i class="fas fa-exclamation-triangle mr-1"></i>Partial Approval
                        </p>
                        <div class="text-xs text-gray-700 space-y-1">
                            <div><strong>Approved Dates:</strong> ${request.approvedDates.map(d => formatDate(d)).join(', ')}</div>
                            <div class="text-red-600">
                                <strong>Not Approved:</strong> ${request.requestedDates.filter(d => !request.approvedDates.includes(d)).map(d => formatDate(d)).join(', ') || 'None'}
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>

                <!-- Actions (only for pending) -->
                ${request.status === 'pending' ? `
                <div class="px-4 pb-4 flex gap-2">
                    <button onclick="editRequest(${request.id})" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg text-sm font-bold transition-colors shadow-md">
                        <i class="fas fa-edit mr-1"></i>Edit
                    </button>
                    <button onclick="cancelRequest(${request.id})" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg text-sm font-bold transition-colors shadow-md">
                        <i class="fas fa-trash-alt mr-1"></i>Delete
                    </button>
    </div>
                ` : ''}
            `;

            return card;
        }

        // Format date
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        // Filter by status
        function filterByStatus(status) {
            currentStatusFilter = status;

            // Update button active states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.status === status) {
                    btn.classList.add('active');
                    } else {
                    btn.classList.remove('active');
                }
            });

            renderLeaveRequests();
        }

        // Filter by type
        function filterByType() {
            currentTypeFilter = document.getElementById('typeFilter').value;
            renderLeaveRequests();
        }

        // Edit request (redirect to leave request form with pre-filled data)
        function editRequest(id) {
            const request = leaveRequests.find(r => r.id === id);
            if (!request) {
                showAlert('Request not found', 'error');
                return;
            }

            // Only allow editing pending requests
            if (request.status !== 'pending') {
                showAlert('Only pending requests can be edited', 'error');
                return;
            }

            // Store the request data in localStorage for editing
            localStorage.setItem('editLeaveRequest', JSON.stringify(request));
            
            // Redirect to leave request form
            window.location.href = 'leave-request-multi.html?edit=' + id;
        }

        // Delete/Cancel request
        function cancelRequest(id) {
            const request = leaveRequests.find(r => r.id === id);
            if (!request) {
                showAlert('Request not found', 'error');
                return;
            }

            // Only allow canceling pending requests
            if (request.status !== 'pending') {
                showAlert('Only pending requests can be deleted', 'error');
                return;
            }

            if (confirm(`Are you sure you want to delete this leave request?\n\nType: ${request.typeName}\nDates: ${formatDate(request.startDate)} - ${formatDate(request.endDate)}\nDays: ${request.days}\n\nThis action cannot be undone.`)) {
                // In production: DELETE /api/leaves/request/:id
                console.log('Deleting leave request ID:', id);
                
                const index = leaveRequests.findIndex(r => r.id === id);
                if (index !== -1) {
                    leaveRequests.splice(index, 1);
                    renderLeaveRequests();
                    showAlert('Leave request deleted successfully', 'success');
                }
            }
        }

        // Alert function
        function showAlert(message, type) {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };

            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed top-20 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-lg shadow-lg ${colors[type] || colors.info} text-white text-sm font-medium max-w-sm`;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
    </script>
</body>
</html> 
